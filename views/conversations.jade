extends base.jade

block scripts
	script(type='text/javascript').
		$(document).ready(function () {
			var reloadConversations = function () {
				$('#conversations').html('');
				$.get('/conversations_data/').done(function (data) {
					for (var c in data['conversations']) {
						var rawDate = data['conversations'][c]['lastMessage'];
						var formattedDate = moment(rawDate).format("h:mm:ss A; dddd, MMMM D, YYYY");
						$('#conversations').append('<li class="conversation" data-id="' + data['conversations'][c]['id']
								+ '" id="conversation-'
								+ data['conversations'][c]['id'] + '"><div id="link"><a href="/conversation/'
								+ data['conversations'][c]['id'] + '/">'
								+ data['conversations'][c]['name'] + '</a></div><strong>Members:</strong> <span class="members"></span><div class="date">' + formattedDate + '</div>'
								+ '<div class="controls"><button class="delete">Delete</button></div>'
								+ '</li>');
					}

					for(var i = 0; i < data['conversations'].length; i++) {
						$.get('/conversation_users/' + data['conversations'][i]['id'] + '/', function (userData) {
							var userList = '';
							for (var u in userData['users']) {
								userList += userData['users'][u]['username'];
								if (userData['users'][u] !== userData['users'][userData['users'].length - 1]) {
									userList += ', ';
								}
							}

							if(userData['users'].length > 1) {
								$('#conversation-' + userData['conversationID']).children('.controls').first().children('.delete').first().remove();
							}

							$('#conversation-' + userData['conversationID']).children('.members').first().html(userList);
						});
					}
				});
			};
			reloadConversations();

			$('#formCreateConversation').hide();

			$('#createConversation').click(function () {
				$('#formCreateConversation').slideDown();
			});

			$('body').on('click', '.delete', function () {
				$('body').append('<div id="modalBackground"></div>');
				$('body').append('<div id="modal"><h1>Are you sure you want to delete conversation "'
						+ $(this).parent().parent().children('a').first().text() + '"?</h1>'
						+ '<input type="hidden" id="toDelete" value="' + $(this).parent().parent().data('id') +  '">'
						+ '<button id="confirmDelete">Yes</button> <button id="cancelDelete">No</button>'
						+ '</div>');

				$('#confirmDelete').click(function () {
					$.ajax({
						url: '/conversation/' + $(this).parent().children('#toDelete').first().val() + '/',
						method: 'DELETE',
					}).done(function (data) {
						$('#modal').fadeOut('fast', function () {
							$(this).remove();
						});
						$('#modalBackground').fadeOut('fast', function () {
							$(this).remove();
							reloadConversations();
						});
					});
				});
				$('#cancelDelete').click(function () {
					$('#modal').fadeOut('fast', function () {
						$(this).remove();
					});
					$('#modalBackground').fadeOut('fast', function () {
						$(this).remove();
					});
				});
			});
		});


block content
	h1
		span Conversations
		div#controls
			button#createConversation(type='button') Create

	form#formCreateConversation(method='post')
		label(for='names') To:
		input(type='text', name='names', id='names')
		label(for='names') Name
		input(type='text', name='name', id='name')
		br
		br
		button(type='submit') Create
		button(type='button', id='cancelConversation') Cancel

	ul#conversations
