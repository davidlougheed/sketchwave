extends base.jade

block vars
	- var footer = false

block scripts
	script(type='text/javascript').
		$(document).ready(function () {
			var convID = #{conversationID};

			var active = true;

			var socket = io();
			var authors = {};
			var stamps = {};

			var pastMessages = 0;
			var messagesLoaded = 0;

			var $body = $('body');
			var $cursor = $('#cursor');
			var $messagesContainer = $('#messagesContainer');
			var $editMembersButton = $('#editMembers');
			var $drawPanel = $('#drawPanel');
			var $brushSizeRange = $('#brushSizeRange');
			var $hotSwapButton = $('#hotswap');

			$messagesContainer.append('<div class="loader" '
				+ 'style="position: absolute; left: 50%; margin-left: -23px; margin-top: 50px;"></div>');

			$.post('/stamps/', {conversationID: convID}).done(function (data) {
				for (var s in data['stamps']) {
					stamps = data['stamps'];
				}
			});

			$cursor.hide();

			var drawCanvas = document.getElementById('drawCanvas');
			var ctx = drawCanvas.getContext('2d');
			ctx.mozImageSmoothingEnabled = false;
			ctx.webkitImageSmoothingEnabled = false;
			ctx.msImageSmoothingEnabled = false;
			ctx.imageSmoothingEnabled = false;
			var paint = false;
			var hover = false;

			var brushColor = '#ff0000';
			var brushSize = 5;
			var toolType = 'brush';
			var stamp = 'dolphin';

			var clickX = [];
			var clickY = [];
			var clickDrag = [];
			var clickColor = [];
			var clickSize = [];
			var tool = [];

			var stampTypes = [];

			var background = null;

			var displayMessage = function (username, imageData, date, immediate) {
				$messagesContainer.append('<div class="message">'
						+ '<div class="topBar"><div class="author"><img src="http://placehold.it/36x36"><span>'
						+ username + '</span></div><div class="date">'
						+ date + '</div></div>'
						+ '<div class="image">'
						+ '<img src="' + imageData + '">'
						+ '</div><div class="controls"><button class="importToCanvas transparent noMargin">'
						+ '<i class="material-icons">gesture</i><span>Bastardize</span></button></div>'
						+ '</div>');

				if (immediate) {
					$messagesContainer.scrollTop($messagesContainer[0].scrollHeight);
				} else {
					$messagesContainer.animate({scrollTop: $messagesContainer[0].scrollHeight.toString() + 'px'});
				}
			};

			var displayMetaMessage = function (message) {
				$messagesContainer.append('<div class="metaMessage">' + message + '</div>');
				$messagesContainer.animate({scrollTop: $messagesContainer[0].scrollHeight.toString() + 'px'});
			};

			var clearAllCanvasData = function (backgroundClear) {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				clickX = [];
				clickY = [];
				clickDrag = [];
				clickColor = [];
				clickSize = [];
				tool = [];
				stampTypes = [];
				if (backgroundClear) {
					background = null;
				}
			};

			var moveImageDataToBg = function () {
				background = drawCanvas.toDataURL();
			};

			var refreshMessages = function (immediate) {
				$.get('/conversation_data/' + convID.toString()).then(function (data) {
					// TODO: If not editing
					$('#convName').text(data['conversation']['name']);

					if (data['messages'].length > pastMessages) {
						for (var m = pastMessages; m < data['messages'].length; m++) {
							var rawDate = data['messages'][m]['createdAt'];
							var formattedDate = moment(rawDate).format("h:mm A; MMMM D");
							displayMessage(authors[data['messages'][m]['UserId']]['username'],
									data['messages'][m]['imageData'], formattedDate, immediate);
						}

						pastMessages = data['messages'].length;
					}

					// Done loading, get rid of the loading animation thing
					$messagesContainer.children('.loader').first().remove();
				});
			};

			var redraw = function () {
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				if (background) {
					var bgImage = document.createElement('img');
					bgImage.setAttribute('src', background);
					ctx.drawImage(bgImage, 0, 0, 480, 320);
				}
				ctx.lineJoin = 'round';

				for (var i = 0; i < clickX.length; i++) {
					if (tool[i] == 'brush') {
						// make brush size feel more natural
						ctx.lineWidth = (Math.pow(clickSize[i] / 320, 1.75) * 160) + 1;
						ctx.strokeStyle = clickColor[i];

						ctx.beginPath();

						if (clickDrag[i] && i != 0) {
							ctx.moveTo(clickX[i - 1], clickY[i - 1]);
						} else {
							ctx.moveTo(clickX[i] - 1, clickY[i]);
						}

						ctx.lineTo(clickX[i], clickY[i]);
						ctx.closePath();
						ctx.stroke();
					} else {
						if (stampTypes[i]) {
							var size = clickSize[i] * 1.5;
							if (stampTypes[i] == 'hotswap') {
								ctx.drawImage($('#' + stampTypes[i] + ' img')[0], clickX[i] - Math.round(size / 2),
										clickY[i] - Math.round(size / 3), size, size / 1.5);
							} else {
								ctx.drawImage($('#' + stampTypes[i] + ' img')[0], clickX[i] - (clickSize[i] / 2),
										clickY[i] - (clickSize[i] / 2), clickSize[i], clickSize[i]);
							}
						}
					}
				}
			};

			var addPoint = function (x, y, dragging) {
				clickX.push(x);
				clickY.push(y);
				clickDrag.push(dragging);
				clickColor.push(brushColor);
				clickSize.push(brushSize);

				tool.push(toolType);

				if (toolType == 'brush') {
					stampTypes.push(null);
				} else {
					stampTypes.push(stamp);
				}
			};

			var drawCursor = function (x, y) {
				$cursor.css({'top': (y - 112).toString() + 'px', 'left': x.toString() + 'px'});
			};

			$(drawCanvas).on('mousedown', function (event) {
				var mouseX = event.pageX - $(this).offset().left;
				var mouseY = event.pageY - $(this).offset().top;

				var scaledMouseX = Math.round(mouseX / ($(drawCanvas).width() / 480.0));
				var scaledMouseY = Math.round(mouseY / ($(drawCanvas).height() / 320.0));

				paint = true;

				addPoint(scaledMouseX, scaledMouseY, false);
				redraw();
			});
			$(drawCanvas).on('touchstart', function (event) {
				var touch = event.originalEvent.touches[0] || event.originalEvent.changedTouches[0];

				var mouseX = touch.pageX - $(this).offset().left;
				var mouseY = touch.pageY - $(this).offset().top;

				var scaledMouseX = Math.round(mouseX / ($(drawCanvas).width() / 480.0));
				var scaledMouseY = Math.round(mouseY / ($(drawCanvas).height() / 320.0));

				paint = true;

				addPoint(scaledMouseX, scaledMouseY, false);
				redraw();
			});
			$(drawCanvas).on('mousemove', function (event) {
				if (paint) {
					var mouseX = event.pageX - $(this).offset().left;
					var mouseY = event.pageY - $(this).offset().top;

					var scaledMouseX = Math.round(mouseX / ($(drawCanvas).width() / 480.0));
					var scaledMouseY = Math.round(mouseY / ($(drawCanvas).height() / 320.0));

					addPoint(scaledMouseX, scaledMouseY, true);
					redraw();
				}

				if (hover) {
					drawCursor(event.pageX, event.pageY);
				}
			});
			$(drawCanvas).on('touchmove', function (event) {
				event.preventDefault();

				if (paint) {
					var touch = event.originalEvent.touches[0] || event.originalEvent.changedTouches[0];

					var mouseX = touch.pageX - $(this).offset().left;
					var mouseY = touch.pageY - $(this).offset().top;

					var scaledMouseX = Math.round(mouseX / ($(drawCanvas).width() / 480.0));
					var scaledMouseY = Math.round(mouseY / ($(drawCanvas).height() / 320.0));

					addPoint(scaledMouseX, scaledMouseY, true);
					redraw();
				}
			});

			var onMouseUp = function (event) {
				paint = false;
				moveImageDataToBg();
				if (background) {
					var bgImage = document.createElement('img');
					bgImage.setAttribute('src', background);
					bgImage.onload = function () {
						clearAllCanvasData(false);
						ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
						ctx.drawImage(bgImage, 0, 0, 480, 320);
					};
				}
			};

			$(drawCanvas).on('mouseup', onMouseUp);
			$(drawCanvas).on('touchend', function (event) {
				event.preventDefault();

				onMouseUp(event);
			});
			$(drawCanvas).on('mouseleave', function (event) {
				paint = false;
				hover = false;
				$cursor.hide();
			});

			$(drawCanvas).on('mouseenter', function (event) {
				var mouseX = event.pageX - $(this).offset().left;
				var mouseY = event.pageY - $(this).offset().top;

				hover = true;
				$cursor.show();
				drawCursor(event.pageX, event.pageY);
			});

			$('.colorTool').click(function () {
				toolType = 'brush';
				brushColor = $(this).css('backgroundColor');

				$brushSizeRange.change(); // Refresh size, make sure it's correct

				$(this).parent().children('li').each(function () {
					$(this).removeClass('active');
				});
				$(this).addClass('active');

				$(this).parent().parent().children('#images').children('li').each(function () {
					$(this).removeClass('active');
				});
			});
			$('.stampTool').click(function () {
				toolType = 'stamp';
				stamp = $(this).attr('id');

				$brushSizeRange.change(); // Refresh size, make sure it's correct

				$(this).parent().children('li').each(function () {
					$(this).removeClass('active');
				});
				$(this).addClass('active');

				$(this).parent().parent().children('#colors').children('li').each(function () {
					$(this).removeClass('active');
				});
			});

			$brushSizeRange.on('input change', function () {
				brushSize = Math.round(($(this).val() / 100.0) * 320);
			});

			$('#clear').click(function () {
				clearAllCanvasData(true);
			});
			$('#send').click(function () {
				var messageData = {
					'imageData': drawCanvas.toDataURL(),
					'conversationID': convID
				};

				clearAllCanvasData(true);
				socket.emit('newMessage', messageData);
				pastMessages += 1;

				if (window.innerWidth <= 1040) {
					if ($drawPanel.css('left') != '0px') {
						$drawPanel.css({left: '100%'});
					}
				}

				displayMessage('#{user.username}', messageData.imageData, moment(Date.now()).format("h:mm A; MMMM D"));
			});

			$('#stampIt').click(function () {
				var messageData = {
					'imageData': drawCanvas.toDataURL(),
					'conversationID': convID
				};

				$.post('/stamp/', messageData).done(function (data) {
					$body.append('<div id="modalBackground"></div>');
					$body.append('<div id="modal"><h1>Stamp was added!</h1>'
							+ '<button id="okay">Okay</button>'
							+ '</div>');
					$('#okay, #modalBackground').click(function () {
						$('#modal').fadeOut('fast', function () {
							$(this).remove();
						});
						$('#modalBackground').fadeOut('fast', function () {
							$(this).remove();
						});
					});
				});
			});

			$('#hotkey').click(function () {
				var refreshStamps = function () {
					$.post('/stamps/', {conversationID: convID}).done(function (data) {
						for (var s in data['stamps']) {
							var stampHTML = '<div class="stamp" data-id="' + data['stamps'][s]['id']
									+ '"><img src="' + data['stamps'][s]['imageData'] + '">';
							if (data['stamps'][s]['UserId'] == (#{user.id}).toString()) {
								stampHTML += '<button class="stampDelete transparent noMargin big iconOnly"><i class="material-icons">delete</i></button>';
							}
							stampHTML += '</div>';
							$('#stamps').append(stampHTML);
						}
					});
				};

				$body.append('<div id="modalBackground"></div>');
				$body.append('<div id="modal"><h1><span>User Stamps</span><div class="controls">'
						+ '<button id="closeModal" class="transparent iconOnly big noMargin">'
						+ '<i class="material-icons">clear</i></button></div></h1>'
						+ '<div id="stamps"><div class="stamp"><img src="/images/sciencerules.png"></div></div>'
						+ '</div>');

				refreshStamps();

				$body.on('click', '.stampDelete', function (event) {
					event.stopPropagation();
					$.ajax({
						url: '/stamp/' + $(this).parent().data('id') + '/',
						method: 'DELETE'
					}).done(function (data) {
						$('#stamps').html('<div class="stamp"><img src="/images/sciencerules.png"></div>');
						refreshStamps();
					});
				});

				$('#closeModal, #modalBackground').click(function () {
					$('#modal').fadeOut('fast', function () {
						$(this).remove();
					});
					$('#modalBackground').fadeOut('fast', function () {
						$(this).remove();
					});
				});
			});

			$body.on('click', '.stamp', function () {
				$hotSwapButton.children('img').first().attr('src', ($(this).children('img').first().attr('src')));
				$hotSwapButton.click();

				$('#modal').fadeOut('fast', function () {
					$(this).remove();
				});
				$('#modalBackground').fadeOut('fast', function () {
					$(this).remove();
				});
			});

			$body.on('click', '.importToCanvas', function (event) {
				background = $(this).parent().parent()
						.children('div.image').first().children('img').first().attr('src');
				clearAllCanvasData(false);
				redraw();
			});

			$('#changeName').click(function () {
				$('#convName').replaceWith('<input type="text" id="changeNameText" value="'
						+ $('#convName').text() + '">');
				$('#changeNameText').after(' <div id="nameChangeControls"><button id="saveName"><i class="material-icons">done</i><span>Save</span></button>'
						+ '<button id="cancelChange" class="transparent"><i class="material-icons">clear</i><span>Cancel</span></button></div>');
				$('#saveName').click(function () {
					// TODO: Socket send a message that name has changed

					$.ajax({
						url: '/conversation/' + convID + '/',
						method: 'PUT',
						data: {
							name: $('#changeNameText').val()
						}
					}).done(function (data) {
						$('#saveName').remove();
						$('#cancelChange').remove();

						$('#changeNameText').replaceWith('<span id="convName">'
								+ $('#changeNameText').val() + '</span>');
						$('#changeName').removeAttr('disabled');
					});
				});
				$('#cancelChange').click(function () {
					$('#saveName').remove();
					$('#cancelChange').remove();

					$('#changeNameText').replaceWith('<span id="convName">'
							+ $('#changeNameText').val() + '</span>');
					$('#changeName').removeAttr('disabled');
					$('#changeName').show();
				});
				$(this).attr('disabled', 'disabled');
				$(this).hide();
			});

			$editMembersButton.click(function () {
				$body.append('<div id="modalBackground"></div>');
				var modalHTML = '<div id="modal"><h1><span>Edit Members</span><div class="controls">'
						+ '<button id="closeModal" class="transparent iconOnly big noMargin"><i class="material-icons">clear</i>'
						+ '</button></div></h1><div id="members"></div>'
						+ '<select id="addMemberBox">';

				// TODO: Figure out a better way to deal with authorship...
				for(var a in authors) {
					modalHTML += '<option value="' + authors[a]['username'] + '">'
							+ authors[a]['username'] + '</option>';
				}

				modalHTML += '</select> <button id="addMember">'
						+ '<i class="material-icons">person_add</i> Add Member</button><br><br>'
						+ '</div>';

				$body.append(modalHTML);

				var $membersList = $('#members');
				$('#addMemberBox').select2();

				$.get('/conversation_users/' + convID + '/').done(function (data) {
					for (var u in data['users']) {
						$('#members').append('<div class="member" data-username="'
								+ data['users'][u]['username'] + '">' + data['users'][u]['username']
								+ ' <button class="deleteMember iconOnly transparent">'
								+ '<i class="material-icons">clear</i></button></div>');
					}
				});

				$('#addMember').click(function () {
					var usernameToAdd = $('#addMemberBox').val();
					socket.emit('userAdd', { username: usernameToAdd, conversationID: convID });

					$membersList.append('<div class="member" data-username="'
							+ usernameToAdd + '">' + usernameToAdd
							+ ' <button class="deleteMember iconOnly transparent">'
							+ '<i class="material-icons">clear</i></button></div>');
				});

				$body.on('click', '.deleteMember', function () {
					var usernameToRemove = $(this).parent().data('username');
					socket.emit('userRemove', { username: usernameToRemove, conversationID: convID });
					$(this).parent().remove();
				});

				$('#closeModal, #modalBackground').click(function () {
					$('#modal').fadeOut('fast', function () {
						$(this).remove();
					});
					$('#modalBackground').fadeOut('fast', function () {
						$(this).remove();
					});
				});
			});

			$('#toggleCanvas').click(function () {
				if ($drawPanel.css('left') != '0px') {
					$drawPanel.animate({left: 0});
					$(this).text('Messages');
					$drawPanel.focus();
				} else {
					$drawPanel.animate({left: '100%'});
					$(this).text('Draw');
				}
			});

			$(window).resize(function () {
				if (window.innerWidth > 1040) {
					$drawPanel.css({left: '50%'});
				} else {
					if ($drawPanel.css('left') != '0px') {
						$drawPanel.css({left: '100%'});
					}
				}
			});

			$(window).on('beforeunload', function (event) {
				onMouseUp(event);
				socket.emit('removeUser', {user: #{user.id}, conversationID: convID});
				socket.disconnect();
			});

			window.setInterval(function () {
				if(active) {
					// Keep session alive
					$.get('/keepalive/');
				}
			}, 10000);

			// -----------------

			$brushSizeRange.change();

			socket.emit('userJoin', { user: #{user.id}, conversationID: convID});

			// TODO: Handle add/remove with sockets
			$.get('/users_data/').done(function (data) {
				authors = data['users'];
				refreshMessages(true);
			});

			if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
				Notification.requestPermission();
			}

			socket.on('newMessage', function (data) {
				if(parseInt(data['ConversationId']) == convID) {
					var rawDate = data['createdAt'];
					var formattedDate = moment(rawDate).format("h:mm A; MMMM D");

					displayMessage(authors[data['UserId']]['username'], data['imageData'], formattedDate);

					if (!document.hasFocus() && authors[data['UserId']] != #{user.id}) {
						if (Notification.permission === 'granted') {
							// TODO: Notification toggle
							var notification = new Notification(authors[data['UserId']]['username'] + ' sent a sketch!');
						} else if (Notification.permission !== 'denied') {
							Notification.requestPermission(function (permission) {
								var notification = new Notification(authors[data['UserId']]['username'] + ' sent a sketch!');
							});
						}
					}
				}
			});

			socket.on('changeName', function (name) {
				// TODO: Incorporate whether or not it's being edited...

				displayMetaMessage('The conversation name was changed to "' + name + '"');
			});

			socket.on('userAdd', function (data) {
				authors[data.id] = data;
				displayMetaMessage(data.username + ' was added to the conversation.');
			});
			socket.on('userRemove', function (data) {
				delete authors[data.id];
				displayMetaMessage(data.username + ' was removed from the conversation.');
			});

			socket.on('userJoin', function (data) {
				// TODO: Some form of indication that the user is viewing the chat
			});
			socket.on('userLeave', function (data) {
				// TODO: Some form of indication that the user is no longer viewing the chat
			});
		});


block content
	img#cursor(width='100', height='57', src='/images/cursor.png')
	button#toggleCanvas Draw

	div#conversation
		section#messages
			header
				h1
					span#convName
					div#controls
						button#changeName.transparent
							i.material-icons edit
							span Change Name
						button#editMembers.transparent
							i.material-icons people
							span Members
			section#messagesContainer

		section#drawPanel
			div#scrollIt
				canvas#drawCanvas(height='320', width='480')

				div#tools
					ul#colors
						li#white.colorTool
						li#grey.colorTool
						li#black.colorTool
						li#red.colorTool.active
						li#hotPink.colorTool
						li#yellow.colorTool
						li#blue.colorTool
						li#green.colorTool

					ul#images
						li#dolphin.big.stampTool
							img(src='/images/dolphin.png')
						li#hand.big.stampTool
							img(src='/images/hand.png')
						li#pizza.big.stampTool
							img(src='/images/pizza.png')
						li#gabe.big.stampTool
							img(src='/images/gabe.png')
						li#hotswap.big.stampTool
							img(src='/images/sciencerules.png')
						li#hotkey.big
							i.material-icons collections

					div#brushSize
						h3 Brush Size
						input#brushSizeRange(type='range', min='1', max='100', value='10')

			div#commands
				div(style='float: left;')
					button#stampIt
						i.material-icons image
						span Stamp It!
				div(style='float: right;')
					button#clear.transparent.big.borderRight
						i.material-icons clear
						span Clear
					button#send.iconOnly.transparent.big.highlight
						i.material-icons send
